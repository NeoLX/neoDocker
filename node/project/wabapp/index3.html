<!DOCTYPE html>
<html>

	<head>
		<title>html5调用摄像头实现拍照</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<!-- HTTP 1.1 -->
		<meta http-equiv="pragma" content="no-cache" />
		<!-- HTTP 1.0 -->
		<meta http-equiv="cache-control" content="no-cache" />
		<!-- Prevent caching at the proxy server -->
		<meta http-equiv="expires" content="0" />
		<script type="text/javascript" src="js/jquery.min.js"></script>
	</head>

	<body>
		<div>
			<video id="video" autoplay="false" style='width:640px;height:480px'></video>
		</div>
		<div>
			<button id="paizhao">拍照</button>
			<button id="getfile">获取文件</button>
		</div>
		<div>
			<canvas id="canvas" width="640" height="480"></canvas>
		</div>
		<div id="testfield">

		</div>
		<script type="text/javascript">
			var video = document.getElementById("video");
			var canvas = document.getElementById("canvas");
			var context = canvas.getContext("2d");

			$("#testfield").append('navigator.appCodeName:' + navigator.appCodeName + "<br/>");
			$("#testfield").append('navigator.appName:' + navigator.appName + "<br/>");
			$("#testfield").append('navigator.appVersion:' + navigator.appVersion + "<br/>");
			$("#testfield").append('navigator.platform:' + navigator.platform + "<br/>");
			$("#testfield").append('navigator.userAgent:' + navigator.userAgent + "<br/>");

			// Older browsers might not implement mediaDevices at all, so we set an empty object first
			if(navigator.mediaDevices === undefined) {
				navigator.mediaDevices = {};
			}

			// Some browsers partially implement mediaDevices. We can't just assign an object
			// with getUserMedia as it would overwrite existing properties.
			// Here, we will just add the getUserMedia property if it's missing.
			if(navigator.mediaDevices.getUserMedia === undefined) {
				navigator.mediaDevices.getUserMedia = function(constraints) {

					// First get ahold of the legacy getUserMedia, if present
					var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

					// Some browsers just don't implement it - return a rejected promise with an error
					// to keep a consistent interface
					if(!getUserMedia) {
						return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
					}

					// Otherwise, wrap the call to the old navigator.getUserMedia with a Promise
					return new Promise(function(resolve, reject) {
						getUserMedia.call(navigator, constraints, resolve, reject);
					});
				}
			}

			$(document).ready(function() {
				var errocb = function(err) {
					$("#testfield").append('error:' + JSON.stringify(err));
				};
				var successcb = function(stream) {
					$("#testfield").append('stream:' + stream);
					$("#testfield").append('video:' + video);

					video.srcObject = stream;
					video.play();
				};
				if(navigator.getUserMedia) {
					$("#testfield").append('getUserMedia is enable<br/>');

					navigator.mediaDevices.getUserMedia({
							video: true
						})
						.then(function(stream) {
							var video = document.querySelector('video');
							// Older browsers may not have srcObject
							if("srcObject" in video) {
								video.srcObject = stream;
							} else {
								// Avoid using this in new browsers, as it is going away.
								video.src = window.URL.createObjectURL(stream);
							}
							video.onloadedmetadata = function(e) {
								video.play();
							};
						})
						.catch(function(err) {
							console.log(err.name + ": " + err.message);
						})
					//					navigator.getUserMedia({
					//						"video": true
					//					}, successcb, errocb);
				} else if(navigator.webkitGetUserMedia) {

					$("#testfield").append('webkitGetUserMedia is enable<br/>');

					navigator.webkitGetUserMedia({
						"video": true
					}, function(stream) {
						video.src = window.webkitURL.createObjectURL(stream);
						video.play();
					}, errocb);
				}
				document.getElementById("paizhao").addEventListener("click", function() {
					context.drawImage(video, 0, 0, 640, 480);
					$("#testfield").append('拍照成功<br/>');
				});
				document.getElementById("getfile").addEventListener("click", function() {
					var data = canvas.toDataURL("image/png");
					$("#testfield").append('获取文件成功：[' + data + ']<br/>');
				});

			});
		</script>
	</body>

</html>